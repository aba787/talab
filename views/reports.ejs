
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h2 class="text-center mb-0">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</h2>
                    </div>
                    <div class="card-body">
                        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.total %></h4>
                                        <p class="mb-0">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h4><%= stats.pending %></h4>
                                        <p class="mb-0">ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.inProgress %></h4>
                                        <p class="mb-0">ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.completed %></h4>
                                        <p class="mb-0">ŸÖŸÜÿ¨ÿ≤</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ© -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="statusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ≥ŸÖ</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="departmentChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÅÿµŸÑ ÿ®ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</h5>
                                        <div>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                                                üìä ÿ™ÿµÿØŸäÿ± Excel
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF()">
                                                üìÑ ÿ™ÿµÿØŸäÿ± PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped" id="reportsTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®</th>
                                                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                                        <th>ÿßŸÑŸÇÿ≥ŸÖ</th>
                                                        <th>ÿßŸÑŸÜŸàÿπ</th>
                                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                                        <th>ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</th>
                                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿØŸäŸÖ</th>
                                                        <th>ÿßŸÑŸÖÿØÿ© (ÿ£ŸäÿßŸÖ)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% requests.forEach(request => { 
                                                        const daysDiff = Math.ceil((new Date() - new Date(request.created_at)) / (1000 * 60 * 60 * 24));
                                                    %>
                                                    <tr>
                                                        <td><%= request.request_id %></td>
                                                        <td><%= request.name %></td>
                                                        <td><%= request.department %></td>
                                                        <td><%= request.request_type %></td>
                                                        <td>
                                                            <span class="badge 
                                                                <% if (request.status === 'ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©') { %>bg-warning<% } 
                                                                else if (request.status === 'ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©') { %>bg-info<% } 
                                                                else if (request.status === 'ŸÖŸÜÿ¨ÿ≤') { %>bg-success<% } 
                                                                else { %>bg-secondary<% } %>">
                                                                <%= request.status %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge 
                                                                <% if (request.priority === 'ÿ∑ÿßÿ±ÿ¶ÿ©') { %>bg-danger<% } 
                                                                else if (request.priority === 'ÿπÿßÿ¨ŸÑÿ©') { %>bg-warning<% } 
                                                                else if (request.priority === 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©') { %>bg-info<% } 
                                                                else { %>bg-secondary<% } %>">
                                                                <%= request.priority || 'ÿπÿßÿØŸäÿ©' %>
                                                            </span>
                                                        </td>
                                                        <td><%= new Date(request.created_at).toLocaleDateString('ar-SA') %></td>
                                                        <td><%= daysDiff %></td>
                                                    </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="/admin" class="btn btn-outline-warning">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©</a>
                    <a href="/" class="btn btn-outline-primary">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        // ÿ±ÿ≥ŸÖ ÿ®ŸäÿßŸÜŸä ŸÑŸÑÿ≠ÿßŸÑÿßÿ™
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©', 'ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©', 'ŸÖŸÜÿ¨ÿ≤', 'ŸÖÿ±ŸÅŸàÿ∂'],
                datasets: [{
                    data: [<%= stats.pending %>, <%= stats.inProgress %>, <%= stats.completed %>, <%= stats.rejected || 0 %>],
                    backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // ÿ±ÿ≥ŸÖ ÿ®ŸäÿßŸÜŸä ŸÑŸÑÿ£ŸÇÿ≥ÿßŸÖ
        const deptCtx = document.getElementById('departmentChart').getContext('2d');
        new Chart(deptCtx, {
            type: 'bar',
            data: {
                labels: <%- JSON.stringify(Object.keys(stats.byDepartment || {})) %>,
                datasets: [{
                    label: 'ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™',
                    data: <%- JSON.stringify(Object.values(stats.byDepartment || {})) %>,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // ÿ™ÿµÿØŸäÿ± Excel
        function exportToExcel() {
            const table = document.getElementById('reportsTable');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™_' + new Date().toLocaleDateString('en-CA') + '.xlsx');
        }

        // ÿ™ÿµÿØŸäÿ± PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜÿµ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Ÿäÿ≠ÿ™ÿßÿ¨ ÿÆÿ∑ ÿπÿ±ÿ®Ÿä)
            pdf.text('ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™', 20, 20);
            pdf.text('ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: ' + new Date().toLocaleDateString('ar-SA'), 20, 30);
            
            // ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸáŸÜÿß
            pdf.save('ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™_' + new Date().toLocaleDateString('en-CA') + '.pdf');
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
                        <div class="row mb-4">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4><%= stats.total %></h4>
                                                <p class="mb-0">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</p>
                                            </div>
                                            <div>
                                                <i class="fas fa-clipboard-list fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4><%= stats.pending %></h4>
                                                <p class="mb-0">ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</p>
                                            </div>
                                            <div>
                                                <i class="fas fa-clock fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4><%= stats.inProgress %></h4>
                                                <p class="mb-0">ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</p>
                                            </div>
                                            <div>
                                                <i class="fas fa-cogs fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h4><%= stats.completed %></h4>
                                                <p class="mb-0">ŸÖŸÜÿ¨ÿ≤</p>
                                            </div>
                                            <div>
                                                <i class="fas fa-check-circle fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ≥ŸÖ</h5>
                                    </div>
                                    <div class="card-body">
                                        <% Object.keys(stats.byDepartment).forEach(department => { %>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span><%= department %></span>
                                                <span class="badge bg-primary"><%= stats.byDepartment[department] %></span>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ŸÖÿπÿØŸÑ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="progress mb-3" style="height: 25px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: <%= stats.total > 0 ? (stats.completed / stats.total * 100) : 0 %>%">
                                                <%= stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0 %>%
                                            </div>
                                        </div>
                                        <p class="text-muted">
                                            ÿ™ŸÖ ÿ•ŸÜÿ¨ÿßÿ≤ <%= stats.completed %> ŸÖŸÜ ÿ£ÿµŸÑ <%= stats.total %> ÿ∑ŸÑÿ®
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ≠ÿØŸäÿ´ÿ© -->
                        <div class="card">
                            <div class="card-header">
                                <h5>ÿ¢ÿÆÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®</th>
                                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÇÿØŸÖ</th>
                                                <th>ÿßŸÑŸÇÿ≥ŸÖ</th>
                                                <th>ÿßŸÑŸÜŸàÿπ</th>
                                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿØŸäŸÖ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% requests.slice(0, 10).forEach(request => { %>
                                                <tr>
                                                    <td><%= request.request_id || request.barcode %></td>
                                                    <td><%= request.requester_name || request.name %></td>
                                                    <td><%= request.department %></td>
                                                    <td><%= request.type || request.request_type %></td>
                                                    <td>
                                                        <% if (request.status === 'ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©') { %>
                                                            <span class="badge bg-warning">ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</span>
                                                        <% } else if (request.status === 'ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©') { %>
                                                            <span class="badge bg-info">ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</span>
                                                        <% } else if (request.status === 'ŸÖŸÜÿ¨ÿ≤') { %>
                                                            <span class="badge bg-success">ŸÖŸÜÿ¨ÿ≤</span>
                                                        <% } else { %>
                                                            <span class="badge bg-danger">ŸÖÿ±ŸÅŸàÿ∂</span>
                                                        <% } %>
                                                    </td>
                                                    <td>
                                                        <%= request.created_at ? new Date(request.created_at).toLocaleDateString('ar-SA') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ' %>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center">
                            <a href="/admin" class="btn btn-primary me-2">
                                <i class="fas fa-arrow-left me-1"></i>
                                ÿßŸÑÿπŸàÿØÿ© ŸÑÿ®Ÿàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©
                            </a>
                            <a href="/" class="btn btn-secondary">
                                <i class="fas fa-home me-1"></i>
                                ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
