
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h2 class="text-center mb-0">ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช</h2>
                    </div>
                    <div class="card-body">
                        <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.total %></h4>
                                        <p class="mb-0">ุฅุฌูุงูู ุงูุทูุจุงุช</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h4><%= stats.pending %></h4>
                                        <p class="mb-0">ููุฏ ุงููุฑุงุฌุนุฉ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.inProgress %></h4>
                                        <p class="mb-0">ุชุญุช ุงููุนุงูุฌุฉ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4><%= stats.completed %></h4>
                                        <p class="mb-0">ููุฌุฒ</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุงูุฑุณูู ุงูุจูุงููุฉ -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ุชูุฒูุน ุงูุทูุจุงุช ุญุณุจ ุงูุญุงูุฉ</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="statusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>ุงูุทูุจุงุช ุญุณุจ ุงููุณู</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="departmentChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุฌุฏูู ุงูุชูุงุตูู -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">ุชูุฑูุฑ ููุตู ุจุงูุทูุจุงุช</h5>
                                        <div>
                                            <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                                                ๐ ุชุตุฏูุฑ Excel
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF()">
                                                ๐ ุชุตุฏูุฑ PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped" id="reportsTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>ุฑูู ุงูุทูุจ</th>
                                                        <th>ุงูุงุณู</th>
                                                        <th>ุงููุณู</th>
                                                        <th>ุงูููุน</th>
                                                        <th>ุงูุญุงูุฉ</th>
                                                        <th>ุงูุฃููููุฉ</th>
                                                        <th>ุชุงุฑูุฎ ุงูุชูุฏูู</th>
                                                        <th>ุงููุฏุฉ (ุฃูุงู)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% requests.forEach(request => { 
                                                        const daysDiff = Math.ceil((new Date() - new Date(request.created_at)) / (1000 * 60 * 60 * 24));
                                                    %>
                                                    <tr>
                                                        <td><%= request.request_id %></td>
                                                        <td><%= request.name %></td>
                                                        <td><%= request.department %></td>
                                                        <td><%= request.request_type %></td>
                                                        <td>
                                                            <span class="badge 
                                                                <% if (request.status === 'ููุฏ ุงููุฑุงุฌุนุฉ') { %>bg-warning<% } 
                                                                else if (request.status === 'ุชุญุช ุงููุนุงูุฌุฉ') { %>bg-info<% } 
                                                                else if (request.status === 'ููุฌุฒ') { %>bg-success<% } 
                                                                else { %>bg-secondary<% } %>">
                                                                <%= request.status %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge 
                                                                <% if (request.priority === 'ุทุงุฑุฆุฉ') { %>bg-danger<% } 
                                                                else if (request.priority === 'ุนุงุฌูุฉ') { %>bg-warning<% } 
                                                                else if (request.priority === 'ูุชูุณุทุฉ') { %>bg-info<% } 
                                                                else { %>bg-secondary<% } %>">
                                                                <%= request.priority || 'ุนุงุฏูุฉ' %>
                                                            </span>
                                                        </td>
                                                        <td><%= new Date(request.created_at).toLocaleDateString('ar-SA') %></td>
                                                        <td><%= daysDiff %></td>
                                                    </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="/admin" class="btn btn-outline-warning">ููุญุฉ ุงูุฅุฏุงุฑุฉ</a>
                    <a href="/" class="btn btn-outline-primary">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        // ุฑุณู ุจูุงูู ููุญุงูุงุช
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['ููุฏ ุงููุฑุงุฌุนุฉ', 'ุชุญุช ุงููุนุงูุฌุฉ', 'ููุฌุฒ', 'ูุฑููุถ'],
                datasets: [{
                    data: [<%= stats.pending %>, <%= stats.inProgress %>, <%= stats.completed %>, <%= stats.rejected || 0 %>],
                    backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // ุฑุณู ุจูุงูู ููุฃูุณุงู
        const deptCtx = document.getElementById('departmentChart').getContext('2d');
        new Chart(deptCtx, {
            type: 'bar',
            data: {
                labels: <%- JSON.stringify(Object.keys(stats.byDepartment || {})) %>,
                datasets: [{
                    label: 'ุนุฏุฏ ุงูุทูุจุงุช',
                    data: <%- JSON.stringify(Object.values(stats.byDepartment || {})) %>,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // ุชุตุฏูุฑ Excel
        function exportToExcel() {
            const table = document.getElementById('reportsTable');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'ุชูุฑูุฑ_ุงูุทูุจุงุช_' + new Date().toLocaleDateString('en-CA') + '.xlsx');
        }

        // ุชุตุฏูุฑ PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // ุฅุถุงูุฉ ุงููุต ุจุงูุนุฑุจูุฉ (ูุญุชุงุฌ ุฎุท ุนุฑุจู)
            pdf.text('ุชูุฑูุฑ ุงูุทูุจุงุช', 20, 20);
            pdf.text('ุงูุชุงุฑูุฎ: ' + new Date().toLocaleDateString('ar-SA'), 20, 30);
            
            // ูููู ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู ููุง
            pdf.save('ุชูุฑูุฑ_ุงูุทูุจุงุช_' + new Date().toLocaleDateString('en-CA') + '.pdf');
        }
    </script>
</body>
</html>
