<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h2 class="text-center mb-0">لوحة إدارة الطلبات</h2>
                    </div>
                    <div class="card-body">
                        <% if (requests.length === 0) { %>
                            <div class="alert alert-info text-center">
                                لا توجد طلبات حالياً
                            </div>
                        <% } else { %>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>رقم الطلب</th>
                                            <th>الاسم</th>
                                            <th>الهاتف</th>
                                            <th>القسم</th>
                                            <th>نوع الطلب</th>
                                            <th>الأولوية</th>
                                            <th>الحالة</th>
                                            <th>تاريخ التقديم</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% requests.forEach(request => { %>
                                        <tr>
                                            <td class="fw-bold text-primary"><%= request.request_id %></td>
                                            <td><%= request.requester_name || request.name %></td>
                                            <td><%= request.phone || 'غير محدد' %></td>
                                            <td><%= request.department %></td>
                                            <td><%= request.request_type %></td>
                                            <td>
                                                <span class="badge 
                                                    <% if (request.priority === 'طارئة') { %>bg-danger<% } 
                                                    else if (request.priority === 'عاجلة') { %>bg-warning<% } 
                                                    else if (request.priority === 'متوسطة') { %>bg-info<% } 
                                                    else { %>bg-secondary<% } %>">
                                                    <%= request.priority || 'عادية' %>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge 
                                                    <% if (request.status === 'قيد المراجعة') { %>bg-warning<% } 
                                                    else if (request.status === 'تحت المعالجة') { %>bg-info<% } 
                                                    else if (request.status === 'منجز') { %>bg-success<% } 
                                                    else { %>bg-secondary<% } %>">
                                                    <%= request.status %>
                                                </span>
                                            </td>
                                            <td><%= new Date(request.created_at).toLocaleDateString('ar-SA') %></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="showUpdateModal('<%= request.request_id %>', '<%= request.status %>', '<%= request.notes || '' %>')">
                                                    تحديث
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="showDetails('<%= JSON.stringify(request).replace(/"/g, '&quot;') %>')">
                                                    التفاصيل
                                                </button>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="text-center mt-4">
                            <a href="/reports" class="btn btn-info me-2">
                                <i class="fas fa-chart-bar me-1"></i>
                                عرض التقارير
                            </a>
                            <a href="/" class="btn btn-secondary">
                                <i class="fas fa-home me-1"></i>
                                العودة للصفحة الرئيسية
                            </a>
                        </div>
            </div>
        </div>
    </div>

    <!-- Modal تحديث الحالة -->
    <div class="modal fade" id="updateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تحديث حالة الطلب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/admin/update" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="updateRequestId" name="request_id">

                        <div class="mb-3">
                            <label for="updateStatus" class="form-label">الحالة</label>
                            <select class="form-control" id="updateStatus" name="status" required>
                                <option value="قيد المراجعة">قيد المراجعة</option>
                                <option value="تحت المعالجة">تحت المعالجة</option>
                                <option value="منجز">منجز</option>
                                <option value="مرفوض">مرفوض</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="updateNotes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="updateNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal تفاصيل الطلب -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل الطلب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsContent">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showUpdateModal(requestId, currentStatus, currentNotes) {
            document.getElementById('updateRequestId').value = requestId;
            document.getElementById('updateStatus').value = currentStatus;
            document.getElementById('updateNotes').value = currentNotes;

            var modal = new bootstrap.Modal(document.getElementById('updateModal'));
            modal.show();
        }

        function showDetails(requestData) {
            const request = JSON.parse(requestData.replace(/&quot;/g, '"'));
            const detailsContent = document.getElementById('detailsContent');

            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6"><strong>رقم الطلب:</strong> ${request.request_id}</div>
                    <div class="col-md-6"><strong>الاسم:</strong> ${request.name}</div>
                </div><hr>
                <div class="row">
                    <div class="col-md-6"><strong>البريد:</strong> ${request.email}</div>
                    <div class="col-md-6"><strong>الهاتف:</strong> ${request.phone || 'غير محدد'}</div>
                </div><hr>
                <div class="row">
                    <div class="col-md-6"><strong>القسم:</strong> ${request.department}</div>
                    <div class="col-md-6"></div>
                </div><hr>
                <div class="row">
                    <div class="col-md-6"><strong>نوع الطلب:</strong> ${request.request_type}</div>
                    <div class="col-md-6"><strong>الحالة:</strong> ${request.status}</div>
                </div><hr>
                <div><strong>التفاصيل:</strong></div>
                <div class="border p-2 bg-light">${request.description}</div><hr>
                ${request.notes ? `<div><strong>الملاحظات:</strong></div><div class="border p-2 bg-info text-white">${request.notes}</div><hr>` : ''}
                <div class="row">
                    <div class="col-md-6"><small><strong>تاريخ التقديم:</strong> ${new Date(request.created_at).toLocaleString('ar-SA')}</small></div>
                    <div class="col-md-6"><small><strong>آخر تحديث:</strong> ${new Date(request.updated_at).toLocaleString('ar-SA')}</small></div>
                </div>
            `;

            var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }
    </script>
</body>
</html>